(window.webpackJsonp=window.webpackJsonp||[]).push([[90],{534:function(s,e,n){"use strict";n.r(e);var a=n(21),i=Object(a.a)({},(function(){var s=this,e=s.$createElement,n=s._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h3",{attrs:{id:"八、剖析springsession的redis原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#八、剖析springsession的redis原理"}},[s._v("#")]),s._v(" 八、剖析SpringSession的redis原理")]),s._v(" "),n("h4",{attrs:{id:"步骤1-分析springsession的redis数据结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#步骤1-分析springsession的redis数据结构"}},[s._v("#")]),s._v(" 步骤1：分析SpringSession的redis数据结构")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('127.0.0.1:6379> keys *\n1) "spring:session:expirations:1578227700000"\n2) "spring:session:sessions:5eddb9a3-5b1e-4bdd-a289-394b6d42388e"\n3) "spring:session:sessions:expires:5eddb9a3-5b1e-4bdd-a289-394b6d42388e"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v('共同点：3个key都是以spring:session:开头的，代表了SpringSession的redis数据。\n"spring:session:sessions:5eddb9a3-5b1e-4bdd-a289-394b6d42388e"')]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('127.0.0.1:6379> type "spring:session:sessions:5eddb9a3-5b1e-4bdd-a289-394b6d42388e"\nhash\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v('127.0.0.1:6379> hgetall "spring:session:sessions:5eddb9a3-5b1e-4bdd-a289-394b6d42388e"')]),s._v(" "),n("p",[s._v("//失效时间 100分钟")]),s._v(" "),n("ol",[n("li",[s._v('"maxInactiveInterval"')]),s._v(" "),n("li",[s._v('"\\xac\\xed\\x00\\x05sr\\x00\\x11java.lang.Integer\\x12\\xe2\\xa0\\xa4\\xf7\\x81\\x878\\x02\\x00\\x01I\\x00\\x05valuexr\\x00\\x10java.lang.Number\\x86\\xac\\x95\\x1d\\x0b\\x94\\xe0\\x8b\\x02\\x00\\x00xp\\x00\\x00\\x17p"')])]),s._v(" "),n("p",[s._v('// sesson的属性，存储了user对象\n3) "sessionAttr:5eddb9a3-5b1e-4bdd-a289-394b6d42388e"\n4) "\\xac\\xed\\x00\\x05sr\\x00\\x1ecom.agan.redis.controller.User\\x16"_m\\x1b\\xa0W\\x7f\\x02\\x00\\x03I\\x00\\x02idL\\x00\\bpasswordt\\x00\\x12Ljava/lang/String;L\\x00\\busernameq\\x00~\\x00\\x01xp\\x00\\x00\\x00\\x01t\\x00\\x05agan1q\\x00~\\x00\\x03"')]),s._v(" "),n("p",[s._v('// session的创建时间\n5) "creationTime"\n6) "\\xac\\xed\\x00\\x05sr\\x00\\x0ejava.lang.Long;\\x8b\\xe4\\x90\\xcc\\x8f#\\xdf\\x02\\x00\\x01J\\x00\\x05valuexr\\x00\\x10java.lang.Number\\x86\\xac\\x95\\x1d\\x0b\\x94\\xe0\\x8b\\x02\\x00\\x00xp\\x00\\x00\\x01ouW<K"')]),s._v(" "),n("p",[s._v('//最后的访问时间\n7) "lastAccessedTime"\n8) "\\xac\\xed\\x00\\x05sr\\x00\\x0ejava.lang.Long;\\x8b\\xe4\\x90\\xcc\\x8f#\\xdf\\x02\\x00\\x01J\\x00\\x05valuexr\\x00\\x10java.lang.Number\\x86\\xac\\x95\\x1d\\x0b\\x94\\xe0\\x8b\\x02\\x00\\x00xp\\x00\\x00\\x01ouW<L"')]),s._v(" "),n("h4",{attrs:{id:"步骤2-分析springsession的redis过期策略"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#步骤2-分析springsession的redis过期策略"}},[s._v("#")]),s._v(" 步骤2：分析SpringSession的redis过期策略")]),s._v(" "),n("p",[s._v("对于过期数据，一般有三种删除策略：")]),s._v(" "),n("ol",[n("li",[s._v("定时删除，即在设置键的过期时间的同时，创建一个定时器， 当键的过期时间到来时，立即删除。")]),s._v(" "),n("li",[s._v("惰性删除，即在访问键的时候，判断键是否过期，过期则删除，否则返回该键值。")]),s._v(" "),n("li",[s._v("定期删除，即每隔一段时间，程序就对数据库进行一次检查，删除里面的过期键。至于要删除多少过期键，以及要检查多少个数据库，则由算法决定。\n​redis 删除过期数据采用的是懒性删除+定期删除组合策略，也就是数据过期了并不会及时被删除。"),n("br"),s._v("\n但由于redis是单线程，并且redis对删除过期的key优先级很低；如果有大量的过期key，就会出现key已经过期但是未删除。")])]),s._v(" "),n("p",[s._v("为了实现 session 过期的及时性，spring session 采用了定时删除+惰性删除的策略。")]),s._v(" "),n("h5",{attrs:{id:"定时删除"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#定时删除"}},[s._v("#")]),s._v(" 定时删除")]),s._v(" "),n("p",[s._v('"spring:session:expirations:1578227700000"')]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('127.0.0.1:6379> type "spring:session:expirations:1578228240000"\nset\n127.0.0.1:6379> smembers "spring:session:expirations:1578228240000"\n1) "\\xac\\xed\\x00\\x05t\\x00,expires:5eddb9a3-5b1e-4bdd-a289-394b6d42388e"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("springsession 定时（1分钟）轮询，删除spring:session:expirations:[?] 的过期members\n例如：spring:session:expirations:1578228240000 的1578228240000=2020-01-05 20:44:00:000 即在2020-01-05 20:44:00:000过期。\nspringsesion 定时检测超过2020-01-05 20:44:00:000 就删除spring:session:expirations:1578228240000的members的值\nsessionId=5eddb9a3-5b1e-4bdd-a289-394b6d42388e\n即删除")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('1) "spring:session:expirations:1578228240000"\n2) "spring:session:sessions:5eddb9a3-5b1e-4bdd-a289-394b6d42388e"\n3) "spring:session:sessions:expires:5eddb9a3-5b1e-4bdd-a289-394b6d42388e"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h5",{attrs:{id:"惰性删除"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#惰性删除"}},[s._v("#")]),s._v(" 惰性删除")]),s._v(" "),n("p",[s._v("spring:session:sessions:expires:5eddb9a3-5b1e-4bdd-a289-394b6d42388e")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('127.0.0.1:6379> type spring:session:sessions:expires:5eddb9a3-5b1e-4bdd-a289-394b6d42388e\nstring\n127.0.0.1:6379> get spring:session:sessions:expires:5eddb9a3-5b1e-4bdd-a289-394b6d42388e\n""\n127.0.0.1:6379> ttl spring:session:sessions:expires:5eddb9a3-5b1e-4bdd-a289-394b6d42388e\n(integer) 4719\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("访问 spring:session:sessions:expires:5eddb9a3-5b1e-4bdd-a289-394b6d42388e的时候，判断key是否过期，过期则删除，否则返回改进的值。\n例如 访问spring:session:sessions:expires:5eddb9a3-5b1e-4bdd-a289-394b6d42388e的时候\n判断 ttl spring:session:sessions:expires:5eddb9a3-5b1e-4bdd-a289-394b6d42388e是否过期，过期就直接删除")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('1) "spring:session:expirations:1578228240000"\n2) "spring:session:sessions:5eddb9a3-5b1e-4bdd-a289-394b6d42388e"\n3) "spring:session:sessions:expires:5eddb9a3-5b1e-4bdd-a289-394b6d42388e"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])])])}),[],!1,null,null,null);e.default=i.exports}}]);