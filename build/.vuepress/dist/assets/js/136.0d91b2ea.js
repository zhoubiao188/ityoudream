(window.webpackJsonp=window.webpackJsonp||[]).push([[136],{580:function(s,n,e){"use strict";e.r(n);var r=e(21),a=Object(r.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h3",{attrs:{id:"如何确保消息100-消费成功"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#如何确保消息100-消费成功"}},[s._v("#")]),s._v(" 如何确保消息100%消费成功？")]),s._v(" "),e("p",[s._v("为了保证消息100%被消费成功（例如，组内消息读取但处理期间消费者崩溃导致的消息丢失）\nSTREAM 设计2个功能")]),s._v(" "),e("ol",[e("li",[s._v("Pending 列表，用于记录读取但并未处理完毕的消息。")]),s._v(" "),e("li",[s._v("XACK通知， 完成告知redis消息处理完成")])]),s._v(" "),e("h3",{attrs:{id:"xpendiing"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#xpendiing"}},[s._v("#")]),s._v(" XPENDIING")]),s._v(" "),e("p",[s._v("命令XPENDIING 用来获消费组或消费内消费者的未处理完毕的消息。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("XPENDING key group [start end count] [consumer]\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('39.100.196.99:6379> flushdb\nOK\n39.100.196.99:6379> multi\nOK\n39.100.196.99:6379> xadd ordermq * orderno 10001\nQUEUED\n39.100.196.99:6379> xadd ordermq * orderno 10002\nQUEUED\n39.100.196.99:6379> xadd ordermq * orderno 10003\nQUEUED\n39.100.196.99:6379> exec\n1) "1588560150589-0"\n2) "1588560150590-0"\n3) "1588560150590-1"\n(0.71s)\n39.100.196.99:6379> xgroup CREATE ordermq ordergroup 0\nOK\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("p",[s._v("查看已读未处理的消息总数")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('39.100.196.99:6379> XPENDING ordermq ordergroup\n1) (integer) 0\n2) (nil)\n3) (nil)\n4) (nil)\n(1.77s)\n\n39.100.196.99:6379> XREADGROUP GROUP ordergroup consumer-score  COUNT 2 STREAMS ordermq >\n1) 1) "ordermq"\n   2) 1) 1) "1588560150589-0"\n         2) 1) "orderno"\n            2) "10001"\n      2) 1) "1588560150590-0"\n         2) 1) "orderno"\n            2) "10002"\n(1.25s)\n39.100.196.99:6379> XREADGROUP GROUP ordergroup consumer-score  COUNT 2 STREAMS ordermq >\n1) 1) "ordermq"\n   2) 1) 1) "1588560150590-1"\n         2) 1) "orderno"\n            2) "10003"\n\n39.100.196.99:6379> XPENDING ordermq ordergroup\n1) (integer) 3      #3个已读未处理的消息总数\n2) "1588560150589-0" #开始id\n3) "1588560150590-1" #结束id\n4) 1) 1) "consumer-score" #消费者\n      2) "3"              #consumer-scor消费者有3个未读消息\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br")])]),e("p",[s._v("查看已读未处理的消息明细")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('39.100.196.99:6379> XPENDING ordermq ordergroup - + 10\n1) 1) "1588560150589-0"  #消息id\n   2) "consumer-score"   #消费者\n   3) (integer) 180924   #从读取到现在的时间\n   4) (integer) 1        #消息被读取的次数，1次\n2) 1) "1588560150590-0"\n   2) "consumer-score"\n   3) (integer) 180924\n   4) (integer) 1\n3) 1) "1588560150590-1"\n   2) "consumer-score"\n   3) (integer) 173746\n   4) (integer) 1\n(0.59s)\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("p",[s._v("获取具体某个消费者的Pending列表")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('39.100.196.99:6379> XPENDING ordermq ordergroup - + 10  consumer-score\n1) 1) "1588560150589-0" #消息ID\n   2) "consumer-score"  #所属消费者\n   3) (integer) 305600  #IDLE，已读取时长\n   4) (integer) 1       #delivery counter，消息被读取次数\n2) 1) "1588560150590-0"\n   2) "consumer-score"\n   3) (integer) 305600\n   4) (integer) 1\n3) 1) "1588560150590-1"\n   2) "consumer-score"\n   3) (integer) 298422\n   4) (integer) 1\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("上面的结果我们可以看到，我们之前读取的消息，都被记录在Pending列表中，说明全部读到的消息都没有处理，仅仅是读取了")]),s._v(" "),e("h3",{attrs:{id:"xack"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#xack"}},[s._v("#")]),s._v(" XACK")]),s._v(" "),e("p",[s._v("上面的结果我们可以看到，我们之前读取的消息，都被记录在Pending列表中，说明全部读到的消息都没有处理，仅仅是读取了。\n那如何表示消费者处理完毕了消息呢？使用命令 XACK 完成告知消息处理完成，演示如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('39.100.196.99:6379> XPENDING ordermq ordergroup - + 10  consumer-score\n1) 1) "1588560150589-0"\n   2) "consumer-score"\n   3) (integer) 450843\n   4) (integer) 1\n2) 1) "1588560150590-0"\n   2) "consumer-score"\n   3) (integer) 450843\n   4) (integer) 1\n3) 1) "1588560150590-1"\n   2) "consumer-score"\n   3) (integer) 443665\n   4) (integer) 1\n   \n39.100.196.99:6379> xack ordermq ordergroup 1588560150589-0 #通知消息处理结束，用消息id表示\n(integer) 1\n\n39.100.196.99:6379> XPENDING ordermq ordergroup - + 10  consumer-score  #再次查看XPENDING列表\n1) 1) "1588560150590-0"\n   2) "consumer-score"\n   3) (integer) 535677\n   4) (integer) 1\n2) 1) "1588560150590-1"\n   2) "consumer-score"\n   3) (integer) 528499\n   4) (integer) 1\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br")])]),e("p",[s._v("有了这样一个Pending机制，就意味着在某个消费者读取消息但未处理后，消息是不会丢失的。等待消费者再次上线后，\n可以读取该Pending列表，就可以继续处理该消息了，保证消息的有序和不丢失。")])])}),[],!1,null,null,null);n.default=a.exports}}]);