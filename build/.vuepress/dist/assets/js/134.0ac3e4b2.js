(window.webpackJsonp=window.webpackJsonp||[]).push([[134],{578:function(s,a,n){"use strict";n.r(a);var e=n(21),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"redis的im的聊天工具"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#redis的im的聊天工具"}},[s._v("#")]),s._v(" redis的IM的聊天工具")]),s._v(" "),n("h3",{attrs:{id:"什么是redis的stream数据结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#什么是redis的stream数据结构"}},[s._v("#")]),s._v(" 什么是redis的stream数据结构？")]),s._v(" "),n("p",[s._v("Redis 5.0推出了一个新的数据结构：Stream。Stream就是一个流处理 的数据结构.\n基于流处理的数据结构，它的功能应用于类似IM的聊天工具和典型的消息队列。\nRedis 的Stream几乎满足了消息队列具备的全部内容，包括但不限于：\n1.消息ID的序列化生成\n2.消息遍历\n3.消息的阻塞和非阻塞读取\n4.消息的分组消费\n5.未完成消息的处理\n6.消息队列监控")]),s._v(" "),n("p",[s._v("xadd：向Stream追加消息\nxdel：从Stream中删除消息，删除仅仅是设置标志位，不影响消息总长度。\nxrange：获取Stream中的消息列表，自动过滤已经删除的消息。-表示最小值，+表示最大值。\nxlen：获取Stream的消息长度，所有在链表中存在的消息\ndel：删除整个Stream中的所有消息。")]),s._v(" "),n("h4",{attrs:{id:"stream生产消息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#stream生产消息"}},[s._v("#")]),s._v(" stream生产消息")]),s._v(" "),n("p",[s._v("XADD，命令用于在某个stream（流数据）中追加消息,语法如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("xadd key ID field string [field string ...]\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("需要提供key，消息ID方案，消息内容，其中消息内容为key-value型数据。\nID，最常使用*，表示由Redis生成消息ID，这也是强烈建议的方案。\nfield string [field string], 就是当前消息内容，由1个或多个key-value构成。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('39.100.196.99:6379> xadd message * hello zhoubiao\n"1587196058726-0"  #消息ID\n39.100.196.99:6379> xadd message * hello zhoubiao2\n"1587196063320-0"\n39.100.196.99:6379> xadd message * hello zhoubiao3\n"1587196067111-0"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h3",{attrs:{id:"stream独立消费"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#stream独立消费"}},[s._v("#")]),s._v(" stream独立消费")]),s._v(" "),n("p",[s._v("从消息队列中获取消息，XREAD，消费消息")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("xread [COUNT count] [BLOCK milliseconds] STREAMS key [key ...] ID [ID ...]\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("[COUNT count]，用于限定获取的消息数量\n[BLOCK milliseconds]，用于设置XREAD为阻塞模式，默认为非阻塞模式\nID，用于设置由哪个消息ID开始读取。使用0表示从第一条消息开始。（本例中就是使用0），\n消息队列ID是单调递增的，所以通过设置起点，可以向后读取。在阻塞模式中，可以使用，表示最新的消息ID。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('39.100.196.99:6379> xread STREAMS message 0\n1) 1) "message"\n   2) 1) 1) "1587196058726-0"\n         2) 1) "hello"\n            2) "zhoubiao"\n      2) 1) "1587196063320-0"\n         2) 1) "hello"\n            2) "zhoubiao2"\n      3) 1) "1587196067111-0"\n         2) 1) "hello"\n            2) "zhoubiao3"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("h3",{attrs:{id:"消息id的原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#消息id的原理"}},[s._v("#")]),s._v(" 消息ID的原理")]),s._v(" "),n("p",[s._v("上文这个消息id 1587196058726-0，是redis 生成的消息id。\n它由2部分组成：时间戳-序号。时间戳是毫秒级，序号是为了防止相同时间内生成的id重复。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('39.100.196.99:6379> multi\nOK\n39.100.196.99:6379> xadd message * hello zhoubiao1\nQUEUED\n39.100.196.99:6379> xadd message * hello zhoubiao2\nQUEUED\n39.100.196.99:6379> xadd message * hello zhoubiao3\nQUEUED\n39.100.196.99:6379> exec\n1) "1587198991846-0"\n2) "1587198991846-1"\n3) "1587198991846-2"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("h2",{attrs:{id:"im聊天室"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#im聊天室"}},[s._v("#")]),s._v(" IM聊天室")]),s._v(" "),n("p",[s._v("业务场景：互联网很多在线客服，在线咨询，或在线聊天室，例如有2个人 zhoubiao alex ，分别进行在线实时咨询聊天，如下：\nzhoubiao: hi\nalex: hi hi\nzhoubiao: how are you\nalex: I fine")]),s._v(" "),n("h3",{attrs:{id:"zhoubiao的聊天"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#zhoubiao的聊天"}},[s._v("#")]),s._v(" zhoubiao的聊天")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('39.100.196.99:6379> xadd roomA * zhoubiao hi # 发送消息\n"1587199309199-0"\n39.100.196.99:6379> xread BLOCK 600000 STREAMS roomA $ #等10分钟，等消息；指定$表示只接收实时的最新消息。\n1) 1) "roomA"\n   2) 1) 1) "1587199436403-0"\n         2) 1) "alex"\n            2) "hi hi"\n(91.54s)\n39.100.196.99:6379> xadd roomA * zhoubiao "how are you" # 再次发送消息\n"1587199484867-0"\n39.100.196.99:6379> xread BLOCK 600000 STREAMS roomA $  #等10分钟，等消息；\n1) 1) "roomA"\n   2) 1) 1) "1587199523884-0"\n         2) 1) "alex"\n            2) "I fine"\n(28.48s)\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("h3",{attrs:{id:"alex的聊天"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#alex的聊天"}},[s._v("#")]),s._v(" alex的聊天")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('39.100.196.99:6379> xread BLOCK 600000 STREAMS roomA $\n1) 1) "roomA"\n   2) 1) 1) "1587199309199-0"\n         2) 1) "zhoubiao"\n            2) "hi"\n(9.20s)\n39.100.196.99:6379>\n39.100.196.99:6379> xadd roomA *  alex "hi hi"\n"1587199436403-0"\n39.100.196.99:6379> xread BLOCK 600000 STREAMS roomA $\n1) 1) "roomA"\n   2) 1) 1) "1587199484867-0"\n         2) 1) "zhoubiao"\n            2) "how are you"\n(34.58s)\n39.100.196.99:6379> xadd roomA *  alex "I fine"\n"1587199523884-0"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("h3",{attrs:{id:"关于未读消息的处理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#关于未读消息的处理"}},[s._v("#")]),s._v(" 关于未读消息的处理")]),s._v(" "),n("p",[s._v("XREAD的语法如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("xread [COUNT count] [BLOCK milliseconds] STREAMS key [key ...] ID [ID ...]\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("上文的例子中，$代表是一个特殊起始ID读取消息，表示只接收实时最新的频道消息\n也可以用ID来处理，ID代表来取该ID之后的消息。\n这个ID非常重要，主要用在当一个用户断开连接重新加入聊天时，可以通过上一个ID，拉取历史消息：\n例如：当用户读到1587199309199-0在，断开连接了，可以通过如下，拉取历史数据。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('39.100.196.99:6379> xread BLOCK 600000 STREAMS roomA 1587199309199-0\n1) 1) "roomA"\n   2) 1) 1) "1587199436403-0"\n         2) 1) "alex"\n            2) "hi hi"\n      2) 1) "1587199484867-0"\n         2) 1) "zhoubiao"\n            2) "how are you"\n      3) 1) "1587199523884-0"\n         2) 1) "alex"\n            2) "I fine"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("zhoubiao: hi\nalex: hi hi\nzhoubiao: how are you\nalex: I fine")])])}),[],!1,null,null,null);a.default=r.exports}}]);