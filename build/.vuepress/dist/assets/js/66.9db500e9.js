(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{510:function(s,a,t){"use strict";t.r(a);var n=t(21),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h4",{attrs:{id:"mongodb-设计模式解决问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-设计模式解决问题"}},[s._v("#")]),s._v(" MongoDB 设计模式解决问题")]),s._v(" "),t("h4",{attrs:{id:"问题-大文档-很多字段-很多索引"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题-大文档-很多字段-很多索引"}},[s._v("#")]),s._v(" 问题: 大文档，很多字段，很多索引")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    title"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Dunkirk"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    ...\n    release_USA"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2017/07/23"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    release_UK"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2017/08/01"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    release_France"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2017/08/01"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    release_Festival_San_Jose"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2017/07/22"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("例如一个电影叫Dunkirk，美国上映时间2017/07/23，而英国是2017/08/01，法国是2017/08/01，那么有很多个国家我就要建立很多个字段来表示，并且在检索的时候，我们希望的是通过索引，那么就要建立很多个索引，如下")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[s._v("    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" release_USA"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" release_UK"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" release_France"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    ...\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" release_Festival_San_Jose"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n...\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("这样为每一个字段都建立索引非常都麻烦，如果有100个地区，我就要建立100个，那么这种情况如何解决呢？")]),s._v(" "),t("h4",{attrs:{id:"解决方案-列转行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决方案-列转行"}},[s._v("#")]),s._v(" 解决方案: 列转行")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    title"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Dunkirk"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n    release_USA"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2017/07/23"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    release_UK"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2017/08/01"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    release_France"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2017/08/01"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    release_Festival_San_Jose"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2017/07/22"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("我们可以通过将列转化为行来表示如下表示")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  title"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Dunkirk"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n  releases"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" country"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" “"),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("USA")]),s._v("”"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" date"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("”"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2017")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("07")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v("”"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" country"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" “"),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("UK")]),s._v("”"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" date"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("”"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2017")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("08")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("01")]),s._v("”"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("代码就是：")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[s._v("db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("movies"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("createIndex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("“releases"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("country”"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" “releases"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("date”"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("可以看见我们通过数组都方式来建立，这里把国家和日期组合，我只需查询一个索引就支持所有国家都查询")]),s._v(" "),t("h4",{attrs:{id:"模式小结-列转行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#模式小结-列转行"}},[s._v("#")]),s._v(" 模式小结： 列转行")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("场景")]),s._v(" "),t("th",[s._v("痛点")]),s._v(" "),t("th",[s._v("设计模式方案及优点")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("产品属性 ‘color’, ‘size’,‘dimensions’, ... \\n 多语言（多国家）属性")]),s._v(" "),t("td",[s._v("文档中有很多类似的字段 \\n 会用于组合查询搜索，需要见很多索引")]),s._v(" "),t("td",[s._v("转化为数组，一个索引解决所有查询问题")])])])]),s._v(" "),t("h4",{attrs:{id:"问题-模型灵活了-如何管理文档不同版本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题-模型灵活了-如何管理文档不同版本"}},[s._v("#")]),s._v(" 问题: 模型灵活了，如何管理文档不同版本？")]),s._v(" "),t("p",[s._v("2020.12 版本1.0")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ObjectId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5de26f197edd62c5d388babb"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"custer1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"company"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ityoudream.cn"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("2021.1 版本2.0 新增“wechat”字段")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ObjectId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5de26f197edd62c5d388babb"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"custer1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"company"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ityoudream.cn"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"wechat"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dreamalip8"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("可以看到2020.12 版本1.0和2021.1 版本2.0的区别是多了一个wechat字段，那么我们如何来做版本控制呢？")]),s._v(" "),t("h4",{attrs:{id:"解决方案-增加一个版本字段"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决方案-增加一个版本字段"}},[s._v("#")]),s._v(" 解决方案: 增加一个版本字段")]),s._v(" "),t("p",[s._v("我们可以在2021.1 版本中增加一个“schema_version“字段来控制版本，类似与maven依赖中的version标记一样")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("场景")]),s._v(" "),t("th",[s._v("痛点")]),s._v(" "),t("th",[s._v("设计模式方案及优点")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("任何有版本衍变的数据库")]),s._v(" "),t("td",[s._v("文档模型格式多，无法知道其合理性 \\n 升级时候需要更新太多文档")]),s._v(" "),t("td",[s._v("增加一个版本号字段 \\n 快速过滤掉不需要升级的文档 \\n 升级时候对不同版本的文档做不同的处理")])])])]),s._v(" "),t("h4",{attrs:{id:"问题-统计网页点击流量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题-统计网页点击流量"}},[s._v("#")]),s._v(" 问题: 统计网页点击流量")]),s._v(" "),t("p",[t("img",{attrs:{src:"/mongodb/counter.png",alt:"image"}})]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("每访问一个页面都会产生一次数据库计数更新操作\n\n统计数字准确性并不十分重要\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("比如说我们需要做一个网站流量的统计排行榜，我要统计这个页面或者某一个商品被看了多少次，那么最简单的做法就是AuditLog(日志统计)或者WriteDB(写入统计)，假如使用了counter做计数器那么，用户每点击一次就会操作变量+1，同时数据库update，这样频繁的update在高并发情况下一定会蹦的，那么在mongo里面如何解决呢？")]),s._v(" "),t("h4",{attrs:{id:"解决方案-用近似计算-间隔写入"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决方案-用近似计算-间隔写入"}},[s._v("#")]),s._v(" 解决方案: 用近似计算(间隔写入)")]),s._v(" "),t("p",[s._v("mongodb 有一个 increment by 操作也就是inc函数，每增加一次，我就更新一下计数器counter，如果不保证准确性的话，我们可以通过这种近似计算，每10次增加1次，这样总的来说，我们写入的量会减少10倍，那么它的底层是通过random来实现的，10次也就是random(0,9)就是0到9的范围")]),s._v(" "),t("p",[t("img",{attrs:{src:"/mongodb/sj1.png",alt:"image"}})]),s._v(" "),t("h4",{attrs:{id:"模式小结-近似计算"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#模式小结-近似计算"}},[s._v("#")]),s._v(" 模式小结：近似计算")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("场景")]),s._v(" "),t("th",[s._v("痛点")]),s._v(" "),t("th",[s._v("设计模式方案及优点")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("网页计数 \\n 各种结果不需要准确的排名")]),s._v(" "),t("td",[s._v("写入太频繁，消耗系统资源")]),s._v(" "),t("td",[s._v("间隔写入，每隔10次或者100次 \\n 大量减少写入需求")])])])]),s._v(" "),t("h4",{attrs:{id:"问题-业绩排名-游戏排名-商品统计等精确统计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题-业绩排名-游戏排名-商品统计等精确统计"}},[s._v("#")]),s._v(" 问题: 业绩排名，游戏排名，商品统计等精确统计")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("热销榜：某个商品今天卖了多少，这个星期卖了多少，这个月卖了多少？\n\n电影排行：观影者，场次统计\n\n传统解决方案：通过聚合计算\n\n痛点：消耗资源多，聚合计算时间长\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("如果使用传统的解决方案来解决上面的问题，会建立很多个文档，那么会花很多时间去处理，那么系统资源就会被卡住，那么我们如何解决呢？")]),s._v(" "),t("h4",{attrs:{id:"解决方案-用预聚合字段"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决方案-用预聚合字段"}},[s._v("#")]),s._v(" 解决方案: 用预聚合字段")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    product"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(' ”m1 mac book pro"'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    sku"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" “abc123456”"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    quantitiy"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20394")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    daily_sales"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    weekly_sales"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("302")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    monthly_sales"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1419")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("这是一个商品，可以看到我们通过增加预聚合字段daily_sales字段以天来统计，weekly_sales以周来统计，monthly_sales以月来统计，在mongo里面多了这几个字段是完全不影响使用和性能的，当我们每次修改库存的时候也就是quantitiy，那么同时会修改daily_sales、weekly_sales、monthly_sales，这样就解决了问题，并且性能会提升百倍千倍。")]),s._v(" "),t("h4",{attrs:{id:"模式小结-预聚合"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#模式小结-预聚合"}},[s._v("#")]),s._v(" 模式小结：预聚合")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("场景")]),s._v(" "),t("th",[s._v("痛点")]),s._v(" "),t("th",[s._v("设计模式方案及优点")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("准确排名排行榜")]),s._v(" "),t("td",[s._v("统计计算耗时，计算时间长")]),s._v(" "),t("td",[s._v("模型中直接增加统计字段 \\n 每次更新数据时候同时更新统计值")])])])]),s._v(" "),t("h4",{attrs:{id:"mongodb-文档模型设计-小结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-文档模型设计-小结"}},[s._v("#")]),s._v(" MongoDB 文档模型设计：小结")]),s._v(" "),t("p",[t("img",{attrs:{src:"/mongodb/sj2.png",alt:"image"}})])])}),[],!1,null,null,null);a.default=e.exports}}]);